# Alert rules for Artisan Hub

groups:
  - name: artisan_api_alerts
    interval: 30s
    rules:
      # High error rate
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(http_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(http_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (threshold: 5%)"

      # Slow response time
      - alert: SlowResponseTime
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (le, endpoint)
          ) > 5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Slow API response time"
          description: "95th percentile response time is {{ $value }}s for {{ $labels.endpoint }}"

      # High request rate
      - alert: HighRequestRate
        expr: sum(rate(http_requests_total[5m])) > 1000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request rate"
          description: "Request rate is {{ $value }} req/s (threshold: 1000 req/s)"

      # No requests (service down)
      - alert: NoRequests
        expr: sum(rate(http_requests_total[5m])) == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "No incoming requests"
          description: "No requests received in the last 5 minutes. Service may be down."

  - name: artisan_agent_alerts
    interval: 30s
    rules:
      # High agent error rate
      - alert: HighAgentErrorRate
        expr: |
          (
            sum(rate(agent_executions_total{status="error"}[10m]))
            /
            sum(rate(agent_executions_total[10m]))
          ) > 0.10
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High agent error rate"
          description: "Agent error rate is {{ $value | humanizePercentage }} (threshold: 10%)"

      # Agent execution timeout
      - alert: AgentExecutionTimeout
        expr: |
          histogram_quantile(0.95,
            sum(rate(agent_execution_duration_seconds_bucket[10m])) by (le, agent_type)
          ) > 300
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Agent execution taking too long"
          description: "95th percentile execution time is {{ $value }}s for {{ $labels.agent_type }}"

      # Too many active agents
      - alert: TooManyActiveAgents
        expr: active_agents > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Too many active agents"
          description: "{{ $value }} agents are currently active (threshold: 100)"

  - name: artisan_llm_alerts
    interval: 30s
    rules:
      # LLM provider errors
      - alert: LLMProviderErrors
        expr: |
          sum(rate(llm_requests_total{status="error"}[10m])) by (provider) > 10
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "LLM provider errors"
          description: "{{ $labels.provider }} has {{ $value }} errors/min"

      # High LLM latency
      - alert: HighLLMLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(llm_request_duration_seconds_bucket[10m])) by (le, provider)
          ) > 30
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High LLM latency"
          description: "95th percentile latency is {{ $value }}s for {{ $labels.provider }}"

      # High token usage
      - alert: HighTokenUsage
        expr: sum(rate(llm_tokens_used_total[1h])) > 1000000
        for: 1h
        labels:
          severity: warning
        annotations:
          summary: "High token usage"
          description: "Token usage is {{ $value }} tokens/hour (threshold: 1M/hour)"

  - name: artisan_system_alerts
    interval: 30s
    rules:
      # High memory usage
      - alert: HighMemoryUsage
        expr: |
          (
            memory_usage_bytes
            /
            (1024 * 1024 * 1024)
          ) > 4
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}GB (threshold: 4GB)"

      # Service unavailable
      - alert: ServiceUnavailable
        expr: up{job="artisan-backend"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Service is down"
          description: "Artisan backend service is unavailable"

      # Redis unavailable
      - alert: RedisUnavailable
        expr: up{job="redis"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Redis is down"
          description: "Redis service is unavailable"

  - name: artisan_database_alerts
    interval: 30s
    rules:
      # Slow database queries
      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95,
            sum(rate(db_query_duration_seconds_bucket[10m])) by (le, operation, table)
          ) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries"
          description: "95th percentile query time is {{ $value }}s for {{ $labels.operation }} on {{ $labels.table }}"

      # High database connection usage
      - alert: HighDatabaseConnections
        expr: db_connections_active > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High database connection usage"
          description: "{{ $value }} active database connections (threshold: 50)"

  - name: artisan_cache_alerts
    interval: 30s
    rules:
      # Low cache hit rate
      - alert: LowCacheHitRate
        expr: |
          (
            sum(rate(cache_hits_total[10m])) by (cache_type)
            /
            (sum(rate(cache_hits_total[10m])) by (cache_type) + sum(rate(cache_misses_total[10m])) by (cache_type))
          ) < 0.70
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }} for {{ $labels.cache_type }} (threshold: 70%)"
